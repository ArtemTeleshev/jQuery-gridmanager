/*! gridmanager - v0.2.1 - 2014-05-26
* http://neokoenig.github.io/jQuery-gridmanager/
* Copyright (c) 2014 Tom King; Licensed MIT */
!function(a){a.gridmanager=function(b,c){var d=this;d.$el=a(b),d.el=b,d.$el.data("gridmanager",d),d.init=function(){d.options=a.extend({},a.gridmanager.defaultOptions,c),d.log("INIT"),d.rteControl("init"),d.createCanvas(),d.createControls(),d.initControls(),d.initCanvas(),d.log("FINISHED")},d.createCanvas=function(){d.log("+ Create Canvas");var b=d.$el.html();d.$el.html(""),a("<div/>",{id:d.options.canvasId,html:b}).appendTo(d.$el)},d.createControls=function(){d.log("+ Create Controls");var b=[];a.each(d.options.controlButtons,function(a,c){var e=d.generateButtonClass(c);b.push("<a title='Add Row "+e+"' class='"+d.options.controlButtonClass+" add"+e+"'><span class='"+d.options.controlButtonSpanClass+"'></span> "+e+"</a>"),d.generateClickHandler(c)}),d.$el.prepend(a("<div/>",{id:d.options.controlId,"class":d.options.gmClearClass}).prepend(d.options.canvasModal,a("<div/>",{"class":d.options.rowClass}).html(a("<div/>",{"class":"col-md-12"}).html(a("<div/>",{id:"gm-addnew","class":"btn-group"}).html(b.join(""))).append(d.options.controlAppend))))},d.initControls=function(){var b=d.$el.find("#"+d.options.canvasId);d.log("+ InitControls Running"),d.$el.on("click","button.gm-switch",function(){d.status?d.deinitCanvas():d.initCanvas()}).on("click",".gm-editholder",function(){var b=a(this);b.attr("contenteditable")||(b.attr("contenteditable",!0),d.rteControl("attach",b))}).on("click","a.gm-save",function(){d.deinitCanvas(),d.saveremote()}).on("click","a.gm-viewsource",function(){d.deinitCanvas();var c=d.htmlEncode(b.html()),e=a("#canvasModal");e.find(".modal-body").html(a("<pre/>",{"class":"pre-scrollable"}).html(c)),e.modal()}).on("click","a.gm-rowSettings",function(){var b=a(this).closest(d.options.rowSelector),c=b.find(".gm-rowSettingsDrawer");c.length>0?c.remove():b.prepend(d.generateModalRowMarkup(b))}).on("click","button.gm-toggleRowClass",function(){var b=a(this).closest(d.options.rowSelector),c=a(this).text().trim();b.toggleClass(c),b.hasClass(c)?a(this).addClass("btn-danger"):a(this).removeClass("btn-danger")}).on("click","a.gm-addColumn",function(){a(this).parent().after(d.createCol(2))}).on("click","a.gm-colDecrease",function(){var b=a(this).closest("."+d.options.gmEditClass),c=d.getColClass(b);c.colWidth>d.options.colMin&&(c.colWidth--,b.switchClass(c.colClass,d.options.colClass+c.colWidth,200))}).on("click","a.gm-colIncrease",function(){var b=a(this).closest("."+d.options.gmEditClass),c=d.getColClass(b);c.colWidth<d.options.colMax&&(c.colWidth++,b.switchClass(c.colClass,d.options.colClass+c.colWidth,200))}).on("click","a.gm-resetgrid",function(){b.html(""),d.reset()}).on("click","a.gm-removeCol",function(){a(this).closest("."+d.options.gmEditClass).animate({opacity:"hide",width:"hide",height:"hide"},400,function(){this.remove()})}).on("click","a.gm-removeRow",function(){a(this).closest("."+d.options.gmEditClass).animate({opacity:"hide",height:"hide"},400,function(){this.remove()})}).on("click","a.gm-resetgrid, a.gm-remove, a.gm-save, button.gm-switch, a.gm-viewsource, a.gm-addColumn, a.gm-colDecrease, a.gm-colIncrease",function(b){d.log("Clicked: "+a.grep(this.className.split(" "),function(a){return 0===a.indexOf("gm-")}).join()),b.preventDefault()})},d.getColClass=function(b){var c=a.grep(b.attr("class").split(" "),function(a){return 0===a.indexOf(d.options.colClass)}).join(),e=c.replace(d.options.colClass,"");return{colClass:c,colWidth:e}},d.initCanvas=function(){var a=d.$el.find("#"+d.options.canvasId),b=a.find(d.options.colSelector),c=a.find(d.options.rowSelector);d.log("+ InitCanvas Running"),d.$el.find("#gm-addnew").show(),d.activateRows(c),d.activateCols(b),a.sortable({items:d.options.rowSelector,axis:"y",placeholder:"bg-warning",handle:"."+d.options.gmToolClass,forcePlaceholderSize:!0,opacity:.7,revert:!0,tolerance:"pointer",cursor:"move"}),c.sortable({items:d.options.colSelector,axis:"x",handle:"."+d.options.gmToolClass,forcePlaceholderSize:!0,opacity:.7,revert:!0,tolerance:"pointer",cursor:"move"}),d.status=!0},d.deinitCanvas=function(){var a=d.$el.find("#"+d.options.canvasId),b=a.find(d.options.colSelector),c=a.find(d.options.rowSelector);d.log("- deInitCanvas Running"),d.$el.find("#gm-addnew").hide(),d.deactivateRows(c),d.deactivateCols(b),d.cleanup(),d.status=!1},d.saveremote=function(){var b=d.$el.find("#"+d.options.canvasId);a.ajax({type:"POST",url:d.options.remoteURL,data:b.html()}),d.log("Save Function Called")},d.activateRows=function(a){d.log("++ Activate Rows"),a.addClass(d.options.gmEditClass).prepend(d.toolFactory(d.options.rowButtonsPrepend)).append(d.toolFactory(d.options.rowButtonsAppend))},d.deactivateRows=function(a){d.log("-- DeActivate Rows"),a.removeClass(d.options.gmEditClass).removeClass("ui-sortable").removeAttr("style")},d.createRow=function(b){var c=a("<div/>",{"class":d.options.rowClass+" "+d.options.gmEditClass});return a.each(b,function(a,b){c.append(d.createCol(b))}),c.prepend(d.toolFactory(d.options.rowButtonsPrepend)).append(d.toolFactory(d.options.rowButtonsPrepend)),d.log("++ Created Row"),c},d.generateModalRowMarkup=function(b){var c="",e="",f="<div class='gm-rowSettingsDrawer "+d.options.gmToolClass+" "+d.options.gmClearClass+"'>",g="</div>";return a.each(d.options.rowCustomClasses,function(a,c){e=b.hasClass(c)?e+"<button class='"+d.options.controlButtonClass+" btn-danger gm-toggleRowClass'><span class='"+d.options.controlButtonSpanClass+"'></span> "+c+"</button>":e+"<button class='"+d.options.controlButtonClass+" gm-toggleRowClass'><span class='"+d.options.controlButtonSpanClass+"'></span> "+c+"</button>"}),c=f+"<div class='btn-group'>"+e+"</div>"+g},d.activateCols=function(b){b.addClass(d.options.gmEditClass),a.each(b,function(b,c){var e=d.toolFactory(d.options.colButtonsPrepend)+"<div class='gm-editholder'>",f="</div>"+d.toolFactory(d.options.colButtonsAppend),g=a(c).html(),h=a.grep(c.className.split(" "),function(a){return 0===a.indexOf(d.options.colClass)}).join();a(c).html(e+g+f).find(".gm-handle-col").attr("title","Move "+h)}),d.log("++ Activate Cols Ran")},d.deactivateCols=function(b){b.removeClass(d.options.gmEditClass),a.each(b,function(b,c){var d=a(c).find(".gm-editholder").html();a(c).html(d)}),d.log("-- deActivate Cols Ran")},d.createCol=function(b){var c=a("<div/>",{"class":d.options.colClass+b+" "+d.options.gmEditClass}).html(d.toolFactory(d.options.colButtonsPrepend)).append(a("<div/>",{"class":"gm-editholder"}).html("<p>Awaiting Content</p>").append(d.toolFactory(d.options.colButtonsAppend)));return d.log("++ Created Column "+b),c},d.toolFactory=function(b){var c=a("<div/>",{"class":d.options.gmToolClass+" "+d.options.gmClearClass}).html(d.buttonFactory(b));return c[0].outerHTML},d.buttonFactory=function(b){var c=[];return a.each(b,function(a,b){c.push("<"+b.element+" title='"+b.title+"' class='"+b.btnClass+"'><span class='"+b.iconClass+"'></span></"+b.element+"> ")}),c.join("")},d.generateButtonClass=function(b){var c="";return a.each(b,function(a,b){c=c+"-"+b}),c},d.generateClickHandler=function(a){var b="a.add"+d.generateButtonClass(a),c=d.$el.find("#"+d.options.canvasId);d.$el.on("click",b,function(e){d.log("Clicked "+b),c.prepend(d.createRow(a)),d.reset(),e.preventDefault()})},d.rteControl=function(b,c){switch(d.log("RTE "+d.options.rte+" "+b),b){case"init":"undefined"!=typeof window.CKEDITOR&&(d.options.rte="ckeditor",d.log("++ CKEDITOR Found"),window.CKEDITOR.disableAutoInline=!0),"undefined"!=typeof window.tinymce&&(d.options.rte="tinymce",d.log("++ TINYMCE Found"));break;case"attach":switch(d.options.rte){case"tinymce":c.hasClass("mce-content-body")||c.tinymce(d.options.tinymce.config);break;case"ckeditor":a(c).ckeditor(d.options.ckeditor),d.log(this);break;default:d.log("No RTE specified for attach")}break;case"stop":switch(d.options.rte){case"tinymce":window.tinymce.remove(),d.log("-- TinyMCE destroyed");break;case"ckeditor":for(var e in window.CKEDITOR.instances)window.CKEDITOR.instances[e].destroy();d.log("-- CKEDITOR destroyed");break;default:d.log("No RTE specified for stop")}break;default:d.log("No RTE Action specified")}},d.reset=function(){d.log("~~RESET~~"),d.deinitCanvas(),d.initCanvas()},d.cleanup=function(){var a=d.$el.find("#"+d.options.canvasId);a.find(d.options.colSelector).removeAttr("style").removeAttr("spellcheck").removeAttr("id").removeClass("mce-content-body").end().find("img").removeAttr("style").addClass("img-responsive").removeAttr("data-cke-saved-src").removeAttr("data-mce-src").end().find("."+d.options.gmToolClass).remove(),d.rteControl("stop"),d.log("~~Cleanup Ran~~")},d.log=function(a){d.options.debug&&void 0!==window.console&&window.console.log(a)},d.htmlEncode=function(a){return a?jQuery("<pre />").text(a).html():""},d.init()},a.gridmanager.defaultOptions={debug:0,remoteURL:"/replace-with-your-url",canvasId:"gm-canvas",canvasModal:"<div id='canvasModal' class='modal fade' tabindex='-1' role='dialog' aria-labelledby='canvasModal' aria-hidden='true'><div class='modal-dialog modal-lg'><div class='modal-content'><div class='modal-header'><button type='button' class='close' data-dismiss='modal' aria-hidden='true'>&times;</button><h4 class='modal-title' id='myModalLabel'>GridManager</h4></div><div class='modal-body'></div></div></div></div></div>",controlId:"gm-controls",controlButtons:[[12],[6,6],[4,4,4],[3,3,3,3],[2,2,2,2,2,2],[2,8,2],[4,8],[8,4]],controlButtonClass:"btn  btn-xs  btn-primary",controlButtonSpanClass:"glyphicon glyphicon-plus-sign",controlAppend:"<div class='btn-group pull-right'><button type='button' class='btn btn-xs btn-primary gm-switch'><span class='glyphicon glyphicon-off'></span> Editor</button><button type='button' class='btn  btn-xs  btn-primary dropdown-toggle' data-toggle='dropdown'><span class='caret'></span><span class='sr-only'>Toggle Dropdown</span></button><ul class='dropdown-menu' role='menu'><li><a title='Save'  href='#' class='gm-save'><span class='glyphicon glyphicon-ok'></span> Save</a></li><li><a title='View Source' href='#' class='gm-viewsource'><span class='glyphicon glyphicon-zoom-in'></span> View Source</a></li><li><a title='Reset Grid' href='#' class='gm-resetgrid'><span class='glyphicon glyphicon-trash'></span> Reset</a></li></ul></div>",gmEditClass:"gm-editing",gmToolClass:"gm-tools",gmClearClass:"clearfix",rowClass:"row",rowSelector:"div.row",rowButtonsPrepend:[{title:"New Column",element:"a",btnClass:"gm-addColumn pull-left  ",iconClass:"glyphicon glyphicon-plus"},{title:"Row Settings",element:"a",btnClass:"pull-right gm-rowSettings",iconClass:"glyphicon glyphicon-cog"}],rowButtonsAppend:[{title:"Remove row",element:"a",btnClass:"pull-right gm-removeRow",iconClass:"glyphicon glyphicon-trash"}],rowSettingControls:"Reserved for future use",rowCustomClasses:["gray","blue","rounded-img-corners"],colClass:"col-md-",colSelector:"div[class*=col-]",colButtonsPrepend:[{title:"Make Column Narrower",element:"a",btnClass:"gm-colDecrease pull-left",iconClass:"glyphicon glyphicon-minus-sign"},{title:"Make Column Wider",element:"a",btnClass:"gm-colIncrease pull-left",iconClass:"glyphicon glyphicon-plus-sign"}],colButtonsAppend:[{title:"Remove Column",element:"a",btnClass:"pull-right gm-removeCol",iconClass:"glyphicon glyphicon-trash"}],colMin:1,colMax:12,tinymce:{config:{inline:!0,plugins:["advlist autolink lists link image charmap print preview anchor","searchreplace visualblocks code fullscreen","insertdatetime media table contextmenu paste"],toolbar:"insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image"}},ckeditor:{customConfig:""}},a.fn.gridmanager=function(b){return this.each(function(){new a.gridmanager(this,b)})}}(jQuery);